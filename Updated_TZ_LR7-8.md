
# PIS_LR_7-8

## 1. Описание предметной области
### Система разработана для управления электронной коммерцией. Основной функционал включает:
- Регистрацию и управление пользователями.
- Поиск и выбор товаров.
- Оформление заказов, включая выбор способов доставки и оплаты.
- Проведение платежей через интеграцию с внешними системами (например, SberPay).
- Управление заказами и уведомления пользователей.

## 2. Цель и назначение разработки
### Цель: Создать модульный сервис электронной коммерции с интеграцией платежей и удобным пользовательским интерфейсом.

### Назначение: 
- Масштабируемость системы для увеличения числа пользователей и товаров.
- Гибкость и простоту добавления новых функций.
- Надежность при сбоях отдельных компонентов.

## 3. Краткое описание функционала (ЛР 4-6)
### ЛР4: Разработка пользовательского интерфейса для оформления заказа:
- Ввод контактных данных.
- Выбор способов доставки и оплаты.

### ЛР5: Создание REST API для обработки заказов:
- Добавление товаров в корзину.
- Создание и удаление заказов.
- Интеграция с платежными системами.

### ЛР6: Проектирование микросервисной архитектуры:
- Разделение на независимые модули (Cart, Order, Payment).
- Оптимизация взаимодействия через REST API и асинхронные протоколы.

## 4. Схема архитектуры системы (ЛР6)
![image](https://github.com/user-attachments/assets/9af9515e-501c-42cd-a29e-50a8af04758c)

## 5. ТЗ на front-end
### Макеты страниц:
- Внесение данных для оформления заказа.
- Оплата.

### Примеры макетов:
#### Внесение данных
![image](https://github.com/user-attachments/assets/d38441fe-5dd1-4c76-8456-86fed7ba9ad8)

#### Оплата
![image](https://github.com/user-attachments/assets/20b59c1e-d5d9-42b6-8299-810857a66228)

### Основные элементы формы:
| Элемент                   | Тип элемента | JSON Поле            | Обязательность |
|---------------------------|--------------|----------------------|----------------|
| Поле "Фамилия"            | Input        | clientInfo.lastName  | Обязательное   |
| Поле "Имя"                | Input        | clientInfo.firstName | Обязательное   |
| Поле "Адрес электронной почты" | Input  | contactInfo.email    | Обязательное   |
| Поле "Контактный телефон" | Input        | contactInfo.phone    | Обязательное   |
| Переключатель "Способ оплаты" | Toggle  | paymentMethod.method | Обязательное   |

### Валидация адреса доставки
**Маска ввода адреса**: `г. [Город], ул. [Улица], д. [Дом], кв. [Квартира]`  
Пример: `г. Москва, ул. Тверская, д. 1, кв. 2`.

**Валидационные правила**:
- Длина не менее 10 символов.
- Наличие ключевых слов: "г.", "ул.", "д.", "кв.".
- Запрещены специальные символы, кроме точек и запятых.

**Сообщение об ошибке**:  
*"Пожалуйста, введите адрес в формате: г. [Город], ул. [Улица], д. [Дом], кв. [Квартира]"*.

## 6. ТЗ на back-end
### Модель данных:
- User: Идентификация и контактные данные пользователя.
- Product: Информация о товарах.
- Order: Детали заказа, включая товары и способы доставки.
- Basket_Items: Содержимое корзины.

### Унификация статусов товаров и заказов
#### Товары:
- `ACTIVE` – доступен для покупки.
- `INACTIVE` – временно недоступен.
- `OUT_OF_STOCK` – закончился.

#### Заказы:
- `PENDING` – создан, ожидает оплаты.
- `PAID` – оплата успешно завершена.
- `CANCELED` – заказ отменён.
- `IN_PROGRESS` – выполняется (сборка/доставка).
- `COMPLETED` – выполнен и доставлен.

### Пример запроса для создания заказа:
- URL: `/api/orders`
- Метод: `POST`
- Авторизация: Базовая

#### Тело запроса:
```json
{
  "ProductInfo": {
    "product_name": "Проводные наушники HyperX Cloud II KHX-HSCP-RD красный",
    "article": "12h12322",
    "rating": "4.6",
    "price": 13272
  },
  "clientInfo": {
    "firstName": "Орлов",
    "lastName": "Александр",
    "middleName": "Кириллович"
  },
  "contactInfo": {
    "email": "example@mail.ru",
    "phone": "+7 777 777 02 03"
  },
  "deliveryOfGoods": {
    "inStore": {
      "included": true
    },
    "deliveryToAddress": {
      "included": false,
      "address": "г.Клин Ул.полевая д.45",
      "price": 2000
    }
  },
  "paymentMethod": {
    "SBP": { "included": false },
    "SBERPay": { "included": false },
    "Card": { "included": false },
    "CashOnDelivery": { "included": true }
  }
}
```

### Логика обработки успешной и неуспешной оплаты
#### При успешной оплате:
- Статус заказа обновляется на `PAID`.
- В Kafka отправляется событие об успешной оплате.
- Логируется информация о платеже.

#### При неуспешной оплате:
- Сообщение клиенту: *"Оплата не прошла. Попробуйте снова или выберите другой способ оплаты."*
- Статус заказа остаётся `PENDING`.

### Kafka: сообщения и события
1. **Уведомление об успешной оплате**:  
   - Тема: `payment.success`.  
   - Сообщение:  
     ```json
     {
       "orderId": "uuid",
       "userId": "uuid",
       "status": "PAID",
       "paymentDate": "2024-12-09T12:00:00Z"
     }
     ```

2. **Изменение статуса заказа**:  
   - Тема: `order.status.update`.  
   - Сообщение:  
     ```json
     {
       "orderId": "uuid",
       "status": "IN_PROGRESS",
       "updatedAt": "2024-12-09T12:00:00Z"
     }
     ```

3. **Уведомление о доставке**:  
   - Тема: `delivery.update`.  
   - Сообщение:  
     ```json
     {
       "orderId": "uuid",
       "deliveryStatus": "DELIVERED",
       "deliveryDate": "2024-12-10T15:30:00Z"
     }
     ```

### Интеграция с платёжным шлюзом
Пример ответа шлюза:
```json
{
  "transactionId": "12345abcde",
  "status": "SUCCESS",
  "paymentDate": "2024-12-09T12:00:00Z",
  "amount": 13272
}
```

#### Логика обработки:
- При статусе `SUCCESS`: Обновить статус заказа, отправить уведомление через Kafka.
- При статусе `FAILED`: Вернуть сообщение с описанием ошибки.
